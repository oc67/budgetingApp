
{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}

<style>

.line-form {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.line-form > input,
.line-form > textarea {
    flex: 1;  /* make all children share space */
    margin: 0 !important;
}

.line-form .form-check {
    flex: 0;
    margin-left: auto !important;
}

</style>

<!--Displays the detail of the clicked article -->
<div class="budget-entry">
    
    <h2>Budget {{budget.budget_ID}}: {{budget.budget_month}} {{budget.budget_year}} </h2>
</div>

<hr>

<!--Displays all the comments -->
<h4> Budget header</h4>


<form action="" method="post">{% csrf_token %}
    {{ budgetHeaderForm|crispy }}

Added expenses for the month: £{{monthly_expenses_total}} | ${{monthly_expenses_total_USD|floatformat:2}}
 | €{{monthly_expenses_total_EUR|floatformat:2}}

<br><br>
{{monthly_performance}}
<br><br>

<h4> Budget lines</h4>
  <div id="formset-container">
    {{ budgetLinesForm.management_form }}
    <!--Displays insight lines of budget-->
    {% for form,price in form_totals %}
      <div class="line-form">
            {{ form.id }}
            {{ form|crispy }}
            {{form.DELETE|crispy}}

            </div>
    Total price of line: £  {{price}}
    <br><br>
            
    {% endfor %}
 

 

 </div>
  {% if budget.budget_owner.pk == request.user.pk %}

    <button type="button" id="add-line">Add Line</button>

     <br><br>
    <button class="btn btn-success ml-2" type="submit">Update </button>
     <br>
    <a href="{% url 'budget_delete' budget.budget_ID %}" class="button">Delete</a>
     |  
    <a href="{% url 'budget_export' budget.budget_ID %}" class ="button">Export</a>
     |
  {% endif %}
    <a href="{% url 'budget_transfer' %}" class ="button">Transfer</a>
    <br>
</form>

<!--Javascript code required to display multiple insight lines -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
  document.getElementById('add-line').addEventListener('click', function() {
    const container = document.getElementById('formset-container');
    const totalForms = document.querySelector('input[name="{{ formset.prefix }}-TOTAL_FORMS"]');
    const currentFormCount = parseInt(totalForms.value);

    // Cloning the empty form template:
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;

    // Replacing __prefix__ with currentFormCount in the cloned HTML
    const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, currentFormCount);

    // Insert new form HTML into container
    const div = document.createElement('div');
    div.classList.add('line-form');
    div.innerHTML = newFormHtml;
    container.appendChild(div);

    totalForms.value = currentFormCount + 1;
    });
});
</script>

<!-- Hidden empty form template -->
<div id="empty-form-template" style="display:none;">
  {{ formset.empty_form|crispy }}
</div>

    <p>Back to <a href="{% url 'budget_list' %}">All budgets</a>.</p>

{% endblock content %}